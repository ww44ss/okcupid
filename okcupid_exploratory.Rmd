---
title: "Exploratory Analysis of OkCupid dataset"
author: "Winston Saunders"
date: "August 27, 2016"
output: 
    html_document:
        theme: united
        keep_md: true
---


##Quick Summary  
This explores several relationships in the OkCupid data [published on CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html) which was recently published. Results explored include:  
1. Basic Demographics   
2. The correlation of drinking habits to religion, piety, income, sex and age.
3. Exploration of an income predictor. 


##Getting the Data
The OkCupid data is published on [CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html) as a package for R users. The data set consists of user profile data for 59,946 San Francisco OkCupid users (a free online dating website) from June 2012. The data are describded in the paper: Albert Y. Kim, Adriana Escobedo-Land (2015). OkCupid Profile Data for Introductory Statistics and Data Science Courses. Journal of Statistics Education, 23(2), which you can find [here]( http://www.amstat.org/publications/jse/v23n2/kim.pdf)

```{r, echo=FALSE, message = FALSE}

## OKCupid Data Explore

## Winston Saunders



library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)

```

The raw data is loaded as a library

```{r}
## load data
library(okcupiddata)
```

and it consist of these data fields (detailed descriptions of which can be found in the reference above). 

```{r, echo = TRUE, comment=""}
library(dplyr)

## column names
profiles %>% colnames
```



## Base Demographics


The first thing to look at are the base demographic counts of OkCupid users.

### How many men and women use OkCupid?

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=9}
## clean data
    ## eliminate NAs and restrict age
    cleaned <- filter(profiles, !is.na(age), !is.na(sex), age > 18, age < 80) %>% 
            as_data_frame %>%
            select(sex, age)
    ## make sex-data descriptive
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
   
    
```


```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

        ## plot age histogram
        age_hist <- ggplot(cleaned, aes(x= age, fill = sex)) + geom_bar(position = "dodge", stat = "count")  +
        ggtitle("males v. females") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("count") + 
        xlab("age") +
        theme(legend.position="none")

        cleaned2 <- group_by(cleaned[, c("sex", "age")], sex, age) %>% summarize(n_age = n())



        age_graph <- ggplot(cleaned2, aes(x= age, y = n_age, color = sex)) + geom_line(size = 1.5)  +
        ggtitle("number by age") +
        scale_color_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("number") + 
        xlab("age") +
        theme(legend.position="none")




        ## plot sex histogram
        sex_hist <- ggplot(cleaned, aes(x= sex, fill = sex)) + geom_bar(position = "dodge", stat = "count")  +
        ggtitle("okcupid: sex distribution") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("count") + 
        xlab("age")

        grid.arrange(sex_hist, age_graph, ncol=2)

```

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

    ## compute age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))

    

    ## compute the overall number of men and women
    n_males <- analyzed %>% filter(sex == "male")  
    n_males <- n_males$n_sex %>% sum()
    
    n_females <- analyzed %>% filter(sex == "female") 
    n_females <- n_females$n_sex %>% sum()

```

Overall the number of men, `r n_males`, is about `r round(n_males/n_females, 1)` times greater than the number of females, `r n_females`. This is much larger than the [ratio than reported by OkCupid](https://blog.okcupid.com/index.php/the-case-for-an-older-woman/), perhaps because of the specificity of the geo-location of the data analyzed here (San Francisco only versus the larger OkCupid database as a whole).

A couple of notable features of the chart on the right are that the distributions peaks in the late 20's with a long tail. The number of men and women seems to equalize above out 50. There is also an apparent small "bulge" in the data near age 42, though it is not explored here.  

Another way to look at the data to break age into groups. To do this I compute an age group factor and use `dplyr::group_by` to compute the necessary subtotals

### How do age populations stack up?

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5}
## Compute differences between male and female populations by age.

    ## compute age_group factor using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))
```

This bar chart clearly shows the differences in age populations. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

## GENERATE PLOT

    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    

    p <- ggplot(analyzed, aes(x = sex, y = n_sex, fill = age_group, group=sex)) +
        geom_bar(stat="identity") +
        ggtitle("OkCupid: populations by age and sex") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("number") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
    
    
```


The only problem is it is still hard to compare quantitatively the differences in the populations. 

### How many more men than women are there for a given age-group?  

In this comparison, we express the answer as a relative, rather than absolute, number. For instance, for age = 26, for every two women there are 2 * 1.65, or approximately three, men.

```{r, echo = FALSE, fig.align='center', fig.height=3, warning = FALSE}
    
    
    analyzed2 <- analyzed %>% filter(sex == "male") %>% as.data.frame
    
    
    n.color <- length(unique(analyzed2$age_group))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))

    p <- ggplot(analyzed2, aes(x = age_group, y = 100* (n_sex/(n_age - n_sex) - 1), fill = age_group)) +
        geom_bar(stat="identity", alpha = 1.0) +
        ylab("male/female ratio - 100 (%)") +
        scale_fill_manual(values = getPalette(n.color)) +
        xlab("age") +
        ggtitle("(male/female) population differences by age") +
        theme(legend.position="none") 
    
print(p)
     
```

What is remarkable about this graph is that the number of "excess" men peaks in the late 20's and early 30's, then plateaus for the next couple decades. But in the 50's the number of men relative to women rapidly decreases, crossing zero at about age 60. 

### Are the ages of female users different than male users?  

We know there are difference in the numbers of men and women, but the above data does not clearly reveal if there are differences of age between the respective popluations of men and women. We can explore more intrinsic male and female behavior by separating the male and females populations and normalizing them to the relevant number of users of each sex.  
  
The code to do this counting, similar to the above, is shown below.

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5}

    library(dplyr)

    ## put data into age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 * floor(age/4))
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    age_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_age = n())
    ## count the total number of males and females
    sex_count <- group_by(analyzed[,c("sex")], sex) %>% summarize(n_sex = n())
    ## join the data
    analyzed <- left_join(age_count, sex_count, by = "sex") %>% mutate(freq = n_age/n_sex, freq = ifelse(is.na(freq), 0, freq))
```




```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
    
    ## Generate Distribution and Cummulative Plots

    ## distribution plot is straight forward
    p_dist <- ggplot(analyzed, aes(x = age_group, y = 100*freq, fill = sex, group = sex)) +
        geom_bar(stat = "identity", position = "dodge") +
        #geom_bar(aes(fill = sex), position = "dodge") +
        ggtitle("age distribution of sexes") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("percent of total per sex") + 
        xlab("age_group")
    
    
    ## Cummulative requires some manipuations
    ## first make a "wide" data set
    male <- analyzed %>% filter(sex == "male") %>% select(age_group, sex, freq)
    female <- analyzed %>% filter(sex == "female") %>% select(age_group, sex, freq)

    analyzed_wide <- inner_join(male, female, by = "age_group") %>% mutate(pop_diff = freq.x - freq.y)

    ## compute cummulative sums

    analyzed_wide2 <- analyzed_wide %>% as.data.frame %>% mutate(male_cummul = cumsum(freq.x), female_cummul = cumsum(freq.y))

    ## plot the data
    p_cummul <- ggplot(analyzed_wide2, aes(x = age_group, y = 100*male_cummul, group = sex.x)) +
        geom_line(size = 1.5, color = "#3498DD") +
        geom_line(aes(y = 100*female_cummul, group = sex.y), size = 1.5, color = "#DD9834") +
        ylab("cummulative percent") +
        xlab("age") +
        ggtitle("cummulative distributions by age") 
    


```


Both populations have a [gamma distribution-like shape](https://en.wikipedia.org/wiki/Gamma_distribution) with a mean near 28. The width of both distributions is about 12 years, though it is evident the women's distribution is slightly wider.  
  


```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
grid.arrange(p_dist, p_cummul, ncol=2)
```

So to answer the quest, yes there are differences in the ages of men versus women users, with women users having a wider age range and a relatively greater population at older ages. For instance, about 50% of the of the users of both sexes are between the ages of 24 and 32 (recall the bins in this case are four years wide), and between the ages of 32 and 50 the relative frequency of both men and women are the same. For women, those above age 50 women represent a higher proportion of the female population than men do for the male population.
  
A nice way to look at the data is to create the stacked bar chart below. 

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5}

## Plot data

    library(ggplot2)

    ## build color palettes
    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    ## create plot
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = age_group)) +
        geom_bar(stat="identity") +
        ggtitle("okcupid: age and sex") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
    
    
```

### Religious Affilation of Users

The religion data contains statements of what I will call 'affiliation' and the 'devoutness' of that affilation. For example:

```{r, comment = ""}
set.seed(8675309)
sample(unique(profiles$religion), 4)
```


For a macro view of demographics, let's first strip off the devoutness descriptors to focus on affilation (so, for instance, whether someone typed _"catholicism and somewhat serious about it"_, or _"catholicism and very serious about it"_, they would be have an affiliation of _"catholicism"_) 
  
The data are cleaned by filtering NA's and then grouped and counted as above.

```{r echo=1:5, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(religion_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$religious_affil))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    ## plot numbers of men and women by religion
    p <- ggplot(analyzed, aes(religious_affil, weight = group_count)) +
        geom_bar(aes(fill = religious_affil), alpha = 0.9) +
        ggtitle("Religious Affiliation of Users") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("number") + 
        xlab("religious affiliation")+
        theme(legend.position="none")
    
    #print(p)
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = religious_affil)) +
        geom_bar(stat="identity") +
        ggtitle("religious affiliation") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

It's interesting that the proportion of users reporting an affiliation "atheism" and "agnosticism", while for women  the category "other" along with judeo-christian religions are greater. There is, by proportion, a relatively smaller percentage of eastern religious, with Buddhism being by far the most represented among them. 

### Drinking Habits

Drinking data has just six categories. 

```{r, comment = ""}
set.seed(8675309)
sample(unique(profiles$drinks), 4)
```



```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    ## group the data 
    
    
    drinks_count <- group_by(cleaned[,c("drinks", "sex")], drinks, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(drinks_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = drinks)) +
        geom_bar(stat="identity") +
        ggtitle("drinking habits") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

Clearly the large majority of OkCupid users are social drinkers.

### income

Income data are reported in caterogies as below

```{r, comment = ""}
profiles$income %>% unique() %>% sort()
```



```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(income), !is.na(religion), !is.na(sex)) %>% as_data_frame
    

    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    cleaned$income <- cleaned$income %>% as.factor()
    
    
    ## group the data 
    
    
    income_count <- group_by(cleaned[,c("income", "sex")], income, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(income_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$income))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = income)) +
        geom_bar(stat="identity") +
        ggtitle("reported income") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

Clearly a much larger percentage of women report an income of $20,000 than do men. Men have higher representation incomes above $100,000. The large number of users reporting incomes over $1Million is possibly an artefact of self reporting. 

###Ethnicity

Ethnicity is reported as below is to complext for analysis.

```{r, comment = ""}
set.seed(8765309)
profiles$ethnicity %>% unique() %>% sample(7)
```

Since there are `r length(profiles$ethnicity %>% unique())` unqiue categories, some simplifciation is neeed. In this case, since speed and simplicity are also goals of the analysis, Ijust strip off everything except the first descriptor. This is a gross oversimplication.  

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(income), !is.na(ethnicity), !is.na(sex)) %>% as_data_frame
    
    ## concatenate some word types
    cleaned$ethnicity <- gsub('middle eastern', 'middle_eastern', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('pacific islander', 'pacific_islander', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('native american', 'native_american', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('hispanic \\/ latin', 'hispanic_latin', cleaned$ethnicity) 

    ## strip everything after the first comma
    cleaned$ethnicity <- gsub(',( [a-z_]*)', '', cleaned$ethnicity) %>% as.factor()
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    cleaned$ethnicity <- cleaned$ethnicity %>% as.factor()
    
    
    ## group the data 
    
    
    ethnicity_count <- group_by(cleaned[,c("ethnicity", "sex")], ethnicity, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(ethnicity_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$ethnicity))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = ethnicity)) +
        geom_bar(stat="identity") +
        ggtitle("ethnicity of OkCupid users") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

Clearly the majority of OkCupid users self-identify as white, with small differences between the male and female populations noted.

## Drinking Habits of OkCupid Users

Beyond just simple statistics on age we can look into the correlations of behaviors. In this case, I look at the drinking habits of OkCupid users based on religiosity, income, and age.   


### How do driking habits change with age for men and women?

The manchinery above is easily adapted to exploring the relationship of drinking and age. In this case a very clear pattern emerges for both men and women, with a pronounced  tendency toward lighter driking in older age for women. 

These findings are consistent with results (published)[http://bmcmedicine.biomedcentral.com/articles/10.1186/s12916-015-0273-z] by Annie Britton, Yoav Ben-Shlomo, Michaela Benzeval, Diana Kuh and Steven Bell.


```{r echo=4, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}
    
    ## clean data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(age), !is.na(sex)) %>% as_data_frame
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female",.)
    
    #ggplot(cleaned, aes(x = drinks, y = age)) + 
        #geom_violin(alpha = 0.3, size = 1, fill = "#FF9933", color = "darkred") + 
        #ggtitle("okcupid: drinks versus age") + facet_grid(sex~.)
    
    cleaned <- mutate(cleaned, age_range = 2.5 + 5 * age %/% 5 )
    
    drinks_and_sex <- group_by(cleaned, age_range, sex, drinks) %>% summarize(n=n())
    
    sex <- group_by(cleaned, age_range, sex) %>% summarize(NN=n())
    
    analyzed <- left_join(drinks_and_sex, sex)
    
    analyzed <- mutate(analyzed, percent = 100*n/NN)
    analyzed <- filter(analyzed, age_range >= 20)
    
    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    p <- ggplot(analyzed, aes(age_range, weight = percent)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("drinking and age") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("age")
    
    print(p)
    
```

We can get a better look at the data by with a semi-log plot. In this case the age data has been bucketing into groups of three years. The strong decrease is heavy drinking is apparent for both sexes, though is faster for women than for men. There is an nteresting iuptick in "drinking often" for females in older age. 
    
```{r echo=FALSE, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}   
## clean data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(age), !is.na(sex)) %>% as_data_frame
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female",.)
    
    #ggplot(cleaned, aes(x = drinks, y = age)) + 
        #geom_violin(alpha = 0.3, size = 1, fill = "#FF9933", color = "darkred") + 
        #ggtitle("okcupid: drinks versus age") + facet_grid(sex~.)
    
    cleaned <- mutate(cleaned, age_range = 1.5 + 3 * age %/% 3 )
    
    drinks_and_sex <- group_by(cleaned, age_range, sex, drinks) %>% summarize(n=n())
    
    sex <- group_by(cleaned, age_range, sex) %>% summarize(NN=n())
    
    analyzed <- left_join(drinks_and_sex, sex)
    
    analyzed <- mutate(analyzed, percent = 100*n/NN)
    analyzed <- filter(analyzed, age_range >= 20)


    p3 <- ggplot(analyzed, aes(x = age_range, y = percent, color = drinks)) + geom_line(size = 1.2) +
        scale_color_manual(values = getPalette(n.color)) + 
        facet_grid(sex~.) +
        ggtitle("okcupid: drinking versus age") + 
        scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p3)
    
```  

### Religious Affiliation and Drinking
The religious data contain various statements of both 'affiliation' and what I will call the 'devoutness' of that affilation. For example

```{r, comment = ""}
head(unique(profiles$religion), 10)
```


For a first analysis, I strip off the devoutness descriptors to focus on affilation (so, for instance, whether someone typed _"catholicism and somewhat serious about it"_, or _"catholicism and very serious about it"_, they would be have an affiliation of catholicism).   
  
Drinking habits are characterized by self-described ratings of _"not at all"_, ... _"socially"_, ..._"desperately"_.  
  
The data are cleaned by filtering NA's and then grouped and counted as above.

```{r echo=1:5, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    # Source: local data frame [106 x 4]
    # Groups: drinks, religious_affil [?]
    # 
    #         drinks religious_affil   sex     n
    #         <fctr>          <fctr> <chr> <int>
    # 1  desperately     agnosticism     f    25
    # 2  desperately     agnosticism     m    37
    # 3  desperately         atheism     f    18
    # 4  desperately         atheism     m    40
    # 5  desperately        buddhism     f     5
    # 6  desperately        buddhism     m    15
    # 7  desperately     catholicism     f     4
    # 8  desperately     catholicism     m     7
    # 9  desperately    christianity     f     7
    # 10 desperately    christianity     m     7
    # # ... with 96 more rows
    
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    

    
    analyzed <- left_join(drinks_and_religion, religion_count) %>% mutate(freq = n/group_count, freq = ifelse(is.na(freq), 0, freq))

 
    ## Clean up for display
    
    ## reorder factor
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                           "rarely",
                                                           "socially",
                                                           "often",
                                                           "very often",
                                                           "desperately"))
    
    
    
    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)

    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(9, "Paired"))
    
    
    ## plot
    p <- ggplot(analyzed, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("okcupid: drinking and religion") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("religious affiliation")
    
    print(p)
```

Some obvious patterns revela themselves. Social drinking is by far the largest category.  

### Religious Devoutness and Drinking
Once the above machinery is in place, we can look for differences in the habits of the religiously devout and non-devout. To do this we just select for _"serious about it"_ and _"very serious about it"_ for the devout.


```{r echo=4, fig.align='center', fig.height=4,fig.width=7.5, message = FALSE}
    ## clean religion data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame

    cleaned <- filter(cleaned, grepl("somewhat serious", religion) | grepl("very serious", religion))
    
    

    ## get affiliation (strip modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## convert bnG$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    # Source: local data frame [106 x 4]
    # Groups: drinks, religious_affil [?]
    # 
    #         drinks religious_affil   sex     n
    #         <fctr>          <fctr> <chr> <int>
    # 1  desperately     agnosticism     f    25
    # 2  desperately     agnosticism     m    37
    # 3  desperately         atheism     f    18
    # 4  desperately         atheism     m    40
    # 5  desperately        buddhism     f     5
    # 6  desperately        buddhism     m    15
    # 7  desperately     catholicism     f     4
    # 8  desperately     catholicism     m     7
    # 9  desperately    christianity     f     7
    # 10 desperately    christianity     m     7
    # # ... with 96 more rows
    
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    

    
    analyzed <- left_join(drinks_and_religion, religion_count) %>% mutate(freq = n/group_count, freq = ifelse(is.na(freq), 0, freq))

 
    ## Clean up for display
    
    ## reorder factor
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                           "rarely",
                                                           "socially",
                                                           "often",
                                                           "very often",
                                                           "desperately"))
    
    
    
    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)

    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    
    ## plot
    p_devout <- ggplot(analyzed, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("devout") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("religious affiliation")
    

```

For non-devout we select for _"not too serious"_ and _"laughing about it"_ prior to other cleaning 


```{r echo=4, fig.align='center', fig.height=4,fig.width=9, message = FALSE}
    ## clean religion data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame

    cleaned <- filter(cleaned, grepl("not too serious", religion) | grepl("laughing about it", religion))
    
    # # A tibble: 38,729 x 22
    #       age     body_type                diet
    #       <int>       <chr>               <chr>
    # 1     22 a little extra   strictly anything
    # 2     35        average        mostly other
    # 3     29        average     mostly anything
    # 4     31        average     mostly anything
    # 5     24           <NA>   strictly anything
    # 6     37       athletic     mostly anything
    # 7     28        average     mostly anything
    # 8     24           <NA>              <NA>
    # 9     30         skinny     mostly anything
    # 10    29           thin     mostly anything
    # # ... with 38,719 more rows, and 19 more
    # #   variables: drinks <chr>, drugs <chr>,
    # #   education <chr>, ethnicity <chr>,
    # #   height <int>, income <int>, job <chr>,
    # #   last_online <time>, location <chr>,
    # #   offspring <chr>, orientation <chr>,
    # #   pets <chr>, religion <chr>, sex <chr>,
    # #   sign <chr>, smokes <chr>, speaks <chr>,
    # #   status <chr>, essay0 <chr>
    

    ## get affiliation (strip modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## convert bnG$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    # Source: local data frame [106 x 4]
    # Groups: drinks, religious_affil [?]
    # 
    #         drinks religious_affil   sex     n
    #         <fctr>          <fctr> <chr> <int>
    # 1  desperately     agnosticism     f    25
    # 2  desperately     agnosticism     m    37
    # 3  desperately         atheism     f    18
    # 4  desperately         atheism     m    40
    # 5  desperately        buddhism     f     5
    # 6  desperately        buddhism     m    15
    # 7  desperately     catholicism     f     4
    # 8  desperately     catholicism     m     7
    # 9  desperately    christianity     f     7
    # 10 desperately    christianity     m     7
    # # ... with 96 more rows
    
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    

    
    analyzed <- left_join(drinks_and_religion, religion_count) %>% mutate(freq = n/group_count, freq = ifelse(is.na(freq), 0, freq))

 
    ## Clean up for display
    
    ## reorder factor
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                           "rarely",
                                                           "socially",
                                                           "often",
                                                           "very often",
                                                           "desperately"))
    
    
    
    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)

    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(9, "Paired"))
    
    
    ## plot
    p_non_devout <- ggplot(analyzed, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("non-devout") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("religious affiliation")
    
    
```

```{r, fig.align='center', fig.height=4, fig.width=9, echo=FALSE  }

grid.arrange(p_devout, p_non_devout, ncol = 2)

```


In this case there is a fairly strong difference in the drinking behavior of those who are classified "devout" compared to those in the "non-devout" category.


###Sex and Religion

Surprisingly, men and women greatly differ in religious affiliation, with approximately 45% of men reporting to be either atheist or agnostic versus 35% for women.


```{r echo=FALSE, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}
 
    
    ## clean religion data into broad category
    bnG <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip modifiers) using gsub and simple regex
    bnG$religious_affil <- gsub(' [A-z ]*', '', bnG$religion) %>% as.factor()
    
    ## group the data 
    bnG_rd <- group_by(bnG[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(n = n())
    
    bnG_r <- group_by(bnG[,c("religious_affil", "sex")], sex) %>% summarize(NN = n())
    
  
    bnG_final <- left_join(bnG_rd, bnG_r) %>% mutate(freq = n/NN, freq = ifelse(is.na(freq), 0, freq))
    
    
    
    # Source: local data frame [106 x 6]
    # Groups: drinks, religious_affil [54]
    # 
    #         drinks religious_affil   sex     n    NN        freq
    #         <fctr>          <fctr> <chr> <int> <dbl>       <dbl>
    # 1  desperately     agnosticism     f    25  3184 0.007851759
    # 2  desperately     agnosticism     m    37  5421 0.006825309
    # 3  desperately         atheism     f    18  1882 0.009564293
    # 4  desperately         atheism     m    40  4921 0.008128429
    # 5  desperately        buddhism     f     5   791 0.006321113
    # 6  desperately        buddhism     m    15  1090 0.013761468
    # 7  desperately     catholicism     f     4  2059 0.001942691
    # 8  desperately     catholicism     m     7  2613 0.002678913
    # 9  desperately    christianity     f     7  2606 0.002686109
    # 10 desperately    christianity     m     7  3052 0.002293578
    # # ... with 96 more rows
    

    ## express sex in actual words
    
    bnG_final$sex<- gsub("m", "male", bnG_final$sex)
    bnG_final$sex<- gsub("f", "female", bnG_final$sex)
    
    n.color <- length(unique(analyzed$sex))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    p <- ggplot(bnG_final, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = sex), position = "dodge", alpha = 1) +
        ggtitle("okcupid: sex and religion") +
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("religious affiliation") + 
        coord_flip()
    
    print(p)
    

```

###Income and Drinking Habits




```{r echo = FALSE, fig.align = 'center', fig.height = 4 , fig.width = 7.5 , message = FALSE}
 
    
    ## clean religion data into broad category
    cleaned <- filter(profiles, !is.na(income), !is.na(drinks), !is.na(sex)) %>% as_data_frame
    
    cleaned$income <- cleaned$income %>% as.factor()
    
    
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    ## group the data 
    income_and_drinks <- group_by(cleaned[,c("drinks", "sex", "income")], drinks, sex, income) %>% summarize(n = n())
    
    income <- group_by(cleaned[,c("drinks", "income", "sex")], income) %>% summarize(NN = n())
    
  
    analyzed <- left_join(income_and_drinks, income) %>% mutate(freq = n/NN, freq = ifelse(is.na(freq), 0, freq))
    
    

    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    n.color <- length(unique(analyzed$income))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    
    p <- ggplot(analyzed, aes(income, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), position = "stack", alpha = 1) +
        ggtitle("drinking and income") + 
        facet_grid(sex~.) +
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("income") +
        coord_flip()
        
        #scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p)
    
```    

The most obvious in the graph above is that social drinking, the largest component of the spectrum, shows an obvious trend, with social drinking peaking in the middle of the income range and decreasing on the edges. 

```{r echo = FALSE, fig.align = 'center', fig.height = 3 , fig.width = 7.5 , message = FALSE}

    p3 <- ggplot(analyzed, aes(x = income, y = 100*freq, color = drinks, group = drinks)) + geom_line(size = 1.2) +
        scale_color_manual(values = getPalette(n.color)) + 
        facet_grid(sex~.) +
        ggtitle("drinking and income") + 
        ylab("percent") +
        scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p3)

```


## Some Conclusions  



