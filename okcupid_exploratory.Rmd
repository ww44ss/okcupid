---
title: "Exploratory Analysis of OkCupid dataset"
author: "Winston Saunders"
date: "August 27, 2016"
output: 
    html_document:
        theme: united
        keep_md: true
---


##EXEC SUMMARY  
This explores several relationships in the OkCupid data [published on CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html). Results explored include:  
0. Ages of OkCupid users.   
1. The Correlation of Religion and Drinking Habits.  
2. Changing drinking habits with age.  
3. Religious Affiliation with Age.  
4. TBD 

##Getting the Data
The OkCupid data is published on [CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html) as a package for R suers. The data set consists of user profile data for 59,946 San Francisco OkCupid users (a free online dating website) from June 2012. The data are describded in the paper: Albert Y. Kim, Adriana Escobedo-Land (2015). OkCupid Profile Data for Introductory Statistics and Data Science Courses. Journal of Statistics Education, 23(2), which is found [here]( http://www.amstat.org/publications/jse/v23n2/kim.pdf)

```{r, echo=FALSE, message = FALSE}

## OKCupid Data Explore

## Winston Saunders



library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)

```

The raw data is loaded as a library

```{r}
## load data
library(okcupiddata)
```

and it consist of these data fields (detailed descriptions of which can be found in the reference above). 

```{r, echo = TRUE}
## column names
profiles %>% colnames
```


## Basic Age and Sex Distributions 

The simplest and most obvious thing is to look at first is the sex and age distribution of OkCupid users in a histogram.

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5}
    ## eliminate NAs and restrict age
    cleaned <- filter(profiles, !is.na(age), !is.na(sex), age > 18, age < 80) %>% 
            as_data_frame %>%
            select(sex, age)
    ## make data descriptive
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
   
    
```




```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

        ## plot age histogram
        age_hist <- ggplot(cleaned, aes(x= age, fill = sex)) + geom_bar(position = "dodge", stat = "count")  +
        ggtitle("okcupid: age distribution") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("count") + 
        xlab("age") +
        theme(legend.position="none")




        ## plot sex histogram
        sex_hist <- ggplot(cleaned, aes(x= sex, fill = sex)) + geom_bar(position = "dodge", stat = "count")  +
        ggtitle("okcupid: sex distribution") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("count") + 
        xlab("age")

        grid.arrange(sex_hist, age_hist, ncol=2)

```

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

    ## compute age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))

    

    ## compute the overall number of men and women
    n_males <- analyzed %>% filter(sex == "male")  
    n_males <- n_males$n_sex %>% sum()
    
    n_females <- analyzed %>% filter(sex == "female") 
    n_females <- n_females$n_sex %>% sum()

```

Overall the number of men in `r n_males` and the number of females is `r n_females`, with an overall ratio of about `r round(n_males/n_females, 1)`:1. 

A couple of notable features are that the distributions peaks in the late 20's and that there is a long tail on the distribution.

### Digging deeper into the Male - Female Population Difference

We can dig deeper into the differences in the age group distributions by looking at the differences between them.

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5}

    ## compute age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))
```

A graph of the data shows clearly the diffences in the numbers of male oand female users, with men outnumbering women by an approximately 3:2 ratio for ages below 50, while in the 60's to 70's, women outnumber men by about 6:5.  


```{r, echo = FALSE, fig.align='center', fig.height=3, warning = FALSE}
    
    
    analyzed <- analyzed %>% filter(sex == "male") %>% as.data.frame
    
    
    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))

    p <- ggplot(analyzed, aes(x = age_group, y = delta_percent, group = sex, fill = age_group)) +
        geom_bar(stat="identity", alpha = 1.0) +
        ylab("percent difference") +
        scale_fill_manual(values = getPalette(n.color)) +
        xlab("age") +
        ggtitle("(male - female) population difference by age") +
        theme(legend.position="none") 
    
print(p)
     
```


###Age distribution of male and female populations

The above data show differences male to female populations by age, but they do not reveal what the differences are. We can explore more intrinsic male and female behavior by separating the male and females populations and normalizing them. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

    ## compute age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 * floor(age/4))
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    age_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_age = n())
    ## count the total number of males and females
    sex_count <- group_by(analyzed[,c("sex")], sex) %>% summarize(n_sex = n())
    ## join the data
    analyzed <- left_join(age_count, sex_count, by = "sex") %>% mutate(freq = n_age/n_sex, freq = ifelse(is.na(freq), 0, freq))
    
    ## data snapshot
    
    #    age_group    sex n_age n_sex        freq
    #       <fctr>  <chr> <int> <int>       <dbl>
    # 1         18 female   281 23955 0.011730328
    # 2         18   male   330 35680 0.009248879
    # 3         22 female  2838 23955 0.118472135
    # 4         22   male  3923 35680 0.109949552
    # 5         26 female  5325 23955 0.222291797
    
```



```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
    
    ## Generate Distribution and Cummulative Plots

    ## distribution plot is straight forward
    p_dist <- ggplot(analyzed, aes(x = age_group, y = 100*freq, fill = sex, group = sex)) +
        geom_bar(stat = "identity", position = "dodge") +
        #geom_bar(aes(fill = sex), position = "dodge") +
        ggtitle("okcupid: age distribution of sexes") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("percent of total per sex") + 
        xlab("age_group")
    
    
    ## Cummulative requires some manipuations
    ## first make a "wide" data set
    male <- analyzed %>% filter(sex == "male") %>% select(age_group, sex, freq)
    female <- analyzed %>% filter(sex == "female") %>% select(age_group, sex, freq)

    analyzed_wide <- inner_join(male, female, by = "age_group") %>% mutate(pop_diff = freq.x - freq.y)

    ## compute cummulative sums

    analyzed_wide2 <- analyzed_wide %>% as.data.frame %>% mutate(male_cummul = cumsum(freq.x), female_cummul = cumsum(freq.y))

    ## plot the data
    p_cummul <- ggplot(analyzed_wide2, aes(x = age_group, y = 100*male_cummul, group = sex.x)) +
        geom_line(size = 1.5, color = "#3498DD") +
        geom_line(aes(y = 100*female_cummul, group = sex.y), size = 1.5, color = "#DD9834") +
        ylab("cummulative percent") +
        xlab("age") +
        ggtitle("cummulative populations by age") 
    


```


The populations have a gamma distribution-like shape with a mean near 28.



```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
grid.arrange(p_dist, p_cummul, ncol=2)
```

The cummulative plot highlights the longer tail on the female age distribution. <br>
A normalized bar chart shows the differences in age population by sex, again with women being more numerous at ages above about 50. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

## GENERATE PLOT

    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(8, "Dark2"))
    

    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = age_group)) +
        geom_bar(stat="identity") +
        ggtitle("okcupid: age and sex") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
    
    
```





## RELIGION AND DRINKING


```{r echo=FALSE}
    ## clean religion data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    # # A tibble: 38,729 x 22
    #       age     body_type                diet
    #       <int>       <chr>               <chr>
    # 1     22 a little extra   strictly anything
    # 2     35        average        mostly other
    # 3     29        average     mostly anything
    # 4     31        average     mostly anything
    # 5     24           <NA>   strictly anything
    # 6     37       athletic     mostly anything
    # 7     28        average     mostly anything
    # 8     24           <NA>              <NA>
    # 9     30         skinny     mostly anything
    # 10    29           thin     mostly anything
    # # ... with 38,719 more rows, and 19 more
    # #   variables: drinks <chr>, drugs <chr>,
    # #   education <chr>, ethnicity <chr>,
    # #   height <int>, income <int>, job <chr>,
    # #   last_online <time>, location <chr>,
    # #   offspring <chr>, orientation <chr>,
    # #   pets <chr>, religion <chr>, sex <chr>,
    # #   sign <chr>, smokes <chr>, speaks <chr>,
    # #   status <chr>, essay0 <chr>
    

    ## get affiliation (strip modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## convert bnG$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    # Source: local data frame [106 x 4]
    # Groups: drinks, religious_affil [?]
    # 
    #         drinks religious_affil   sex     n
    #         <fctr>          <fctr> <chr> <int>
    # 1  desperately     agnosticism     f    25
    # 2  desperately     agnosticism     m    37
    # 3  desperately         atheism     f    18
    # 4  desperately         atheism     m    40
    # 5  desperately        buddhism     f     5
    # 6  desperately        buddhism     m    15
    # 7  desperately     catholicism     f     4
    # 8  desperately     catholicism     m     7
    # 9  desperately    christianity     f     7
    # 10 desperately    christianity     m     7
    # # ... with 96 more rows
    
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    

    
    analyzed <- left_join(drinks_and_religion, religion_count) %>% mutate(freq = n/group_count, freq = ifelse(is.na(freq), 0, freq))

 
    ## Clean up for display
    
    ## reorder factor
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                           "rarely",
                                                           "socially",
                                                           "often",
                                                           "very often",
                                                           "desperately"))
    
    
    
    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)

    
    p <- ggplot(analyzed, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("okcupid: drinking and religion") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_brewer(palette = 4, direction = 1) + 
        ylab("percent") + 
        xlab("religious affiliation")
    
    print(p)
```

```{r echo = FALSE}
    
## AGE AND DRINKING
    
    ## clean data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(age), !is.na(sex)) %>% as_data_frame
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female",.)
    
    #ggplot(cleaned, aes(x = drinks, y = age)) + 
        #geom_violin(alpha = 0.3, size = 1, fill = "#FF9933", color = "darkred") + 
        #ggtitle("okcupid: drinks versus age") + facet_grid(sex~.)
    
    cleaned <- mutate(cleaned, age_range = 2.5 + 5 * floor(age / 5) )
    
    drinks_and_sex <- group_by(cleaned, age_range, sex, drinks) %>% summarize(n=n())
    
    sex <- group_by(cleaned, age_range, sex) %>% summarize(NN=n())
    
    analyzed <- left_join(drinks_and_sex, sex)
    
    analyzed <- mutate(analyzed, percent = 100*n/NN)
    analyzed <- filter(analyzed, age_range >= 20)
    
    p <- ggplot(analyzed, aes(age_range, weight = percent)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("okcupid: drinking and age") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_brewer(palette = 4, direction = 1) + 
        ylab("percent") + 
        xlab("age")
    
    print(p)
    
    p3 <- ggplot(analyzed, aes(x = age_range, y = percent, color = drinks)) + geom_line(size = 1.5) +
        facet_grid(sex~.) +
        ggtitle("okcupid: drinking versus age") + 
        scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p3)
    
```  
##SEX VERSUS RELIGION
```{r echo=FALSE}
 
    
    ## clean religion data into broad category
    bnG <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    # # A tibble: 38,729 x 22
    #       age     body_type                diet
    #       <int>       <chr>               <chr>
    # 1     22 a little extra   strictly anything
    # 2     35        average        mostly other
    # 3     29        average     mostly anything
    # 4     31        average     mostly anything
    # 5     24           <NA>   strictly anything
    # 6     37       athletic     mostly anything
    # 7     28        average     mostly anything
    # 8     24           <NA>              <NA>
    # 9     30         skinny     mostly anything
    # 10    29           thin     mostly anything
    # # ... with 38,719 more rows, and 19 more
    # #   variables: drinks <chr>, drugs <chr>,
    # #   education <chr>, ethnicity <chr>,
    # #   height <int>, income <int>, job <chr>,
    # #   last_online <time>, location <chr>,
    # #   offspring <chr>, orientation <chr>,
    # #   pets <chr>, religion <chr>, sex <chr>,
    # #   sign <chr>, smokes <chr>, speaks <chr>,
    # #   status <chr>, essay0 <chr>
    
    
    ## get affiliation (strip modifiers) using gsub and simple regex
    bnG$religious_affil <- gsub(' [A-z ]*', '', bnG$religion) %>% as.factor()
    
   
    ## group the data 
    bnG_rd <- group_by(bnG[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(n = n())
    
    # Source: local data frame [106 x 4]
    # Groups: drinks, religious_affil [?]
    # 
    #         drinks religious_affil   sex     n
    #         <fctr>          <fctr> <chr> <int>
    # 1  desperately     agnosticism     f    25
    # 2  desperately     agnosticism     m    37
    # 3  desperately         atheism     f    18
    # 4  desperately         atheism     m    40
    # 5  desperately        buddhism     f     5
    # 6  desperately        buddhism     m    15
    # 7  desperately     catholicism     f     4
    # 8  desperately     catholicism     m     7
    # 9  desperately    christianity     f     7
    # 10 desperately    christianity     m     7
    # # ... with 96 more rows
    
    
    bnG_r <- group_by(bnG[,c("religious_affil", "sex")], sex) %>% summarize(NN = n())
    
    # Source: local data frame [18 x 3]
    # Groups: religious_affil [?]
    # 
    #    religious_affil   sex    NN
    #             <fctr> <chr> <int>
    # 1      agnosticism     f  3184
    # 2      agnosticism     m  5421
    # 3          atheism     f  1882
    # 4          atheism     m  4921
    # 5         buddhism     f   791
    # 6         buddhism     m  1090
    # 7      catholicism     f  2059
    # 8      catholicism     m  2613
    # 9     christianity     f  2606
    # 10    christianity     m  3052
    # 11        hinduism     f   143
    # 12        hinduism     m   293
    # 13           islam     f    34
    # 14           islam     m    90
    # 15         judaism     f  1476
    # 16         judaism     m  1537
    # 17           other     f  3300
    # 18           other     m  4237
    
    
    
    
    #bnG_rd <- merge(bnG_rd, bnG_r, by = c("religious_affil", "sex")) %>% as_data_frame
    
    # # A tibble: 106 x 5
    #    religious_affil   sex      drinks     n    NN
    #             <fctr> <chr>      <fctr> <int> <int>
    # 1      agnosticism     f desperately    25  3184
    # 2      agnosticism     f      rarely   263  3184
    # 3      agnosticism     f    socially  2412  3184
    # 4      agnosticism     f  very often    27  3184
    # 5      agnosticism     f  not at all   112  3184
    # 6      agnosticism     f       often   345  3184
    # 7      agnosticism     m      rarely   492  5421
    # 8      agnosticism     m    socially  3987  5421
    # 9      agnosticism     m  very often    39  5421
    # 10     agnosticism     m  not at all   244  5421
    # # ... with 96 more rows
    
    
    
    bnG_final <- left_join(bnG_rd, bnG_r) %>% mutate(freq = n/NN, freq = ifelse(is.na(freq), 0, freq))
    
    
    
    # Source: local data frame [106 x 6]
    # Groups: drinks, religious_affil [54]
    # 
    #         drinks religious_affil   sex     n    NN        freq
    #         <fctr>          <fctr> <chr> <int> <dbl>       <dbl>
    # 1  desperately     agnosticism     f    25  3184 0.007851759
    # 2  desperately     agnosticism     m    37  5421 0.006825309
    # 3  desperately         atheism     f    18  1882 0.009564293
    # 4  desperately         atheism     m    40  4921 0.008128429
    # 5  desperately        buddhism     f     5   791 0.006321113
    # 6  desperately        buddhism     m    15  1090 0.013761468
    # 7  desperately     catholicism     f     4  2059 0.001942691
    # 8  desperately     catholicism     m     7  2613 0.002678913
    # 9  desperately    christianity     f     7  2606 0.002686109
    # 10 desperately    christianity     m     7  3052 0.002293578
    # # ... with 96 more rows
    
    ## Clean up for display
    
    
    ## express sex in actual words
    
    bnG_final$sex<- gsub("m", "male", bnG_final$sex)
    bnG_final$sex<- gsub("f", "female", bnG_final$sex)
    
    # # A tibble: 106 x 6
    #         drinks        relig   sex     n    NN        freq
    #         <fctr>       <fctr> <chr> <int> <dbl>       <dbl>
    # 1  desperately  agnosticism     f    25  3184 0.007851759
    # 2  desperately  agnosticism     m    37  3184 0.011620603
    # 3  desperately      atheism     f    18  1882 0.009564293
    # 4  desperately      atheism     m    40  1882 0.021253985
    # 5  desperately     buddhism     f     5   791 0.006321113
    # 6  desperately     buddhism     m    15   791 0.018963338
    # 7  desperately  catholicism     f     4  2059 0.001942691
    # 8  desperately  catholicism     m     7  2059 0.003399709
    # 9  desperately christianity     f     7  2606 0.002686109
    # 10 desperately christianity     m     7  2606 0.002686109
    # # ... with 96 more rows
    
    
    
    p <- ggplot(bnG_final, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = sex), position = "dodge", alpha = 0.9) +
        ggtitle("okcupid: sex and religion") +
        scale_fill_manual(values = c("#AA7788", "#77AA88")) + 
        ylab("percent") + 
        xlab("religious affiliation") + 
        coord_flip()
    
    print(p)
    

```



## SENTIMENT

Let's try looking at the sentiment of the texts

