---
title: "Exploratory Analysis of OkCupid dataset"
author: "Winston Saunders"
date: "August 27, 2016"
output: 
    html_document:
        css: markdown7.css
        toc: true
        toc_depth: 3
        keep_md: true

---


#Summary  
This explores several relationships in the OkCupid data recently [published on CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html). Results explored in this document include the demographics of sex, age, income, religiosity, drinking, and ethnicity of OkCupid users and, as a specific analysis, the correlation of drinking habits to religiosity, income, sex and age.  

Some key observations:   
* The "most common" male and female users are white, single, childless and in their late 20's.  
* 95% of OkCupid users are less than 52 years old.
* Men outnumber women 3:2, though the ratio is strongly age dependent  
* A majority of OkCupid users identify as religiously agnostic.  
* About 75% identify "social drinkers." 
* Drinking habits are strongly dependent on income levels.


#Getting the Data
The OkCupid data is published on [CRAN](https://cran.rstudio.com/web/packages/okcupiddata/index.html) as a package for R users. The data set consists of user profile data for 59,946 San Francisco OkCupid users (a free online dating website) from June 2012. The data are describded in the paper: Albert Y. Kim, Adriana Escobedo-Land (2015). OkCupid Profile Data for Introductory Statistics and Data Science Courses. Journal of Statistics Education, 23(2), which you can find [here]( http://www.amstat.org/publications/jse/v23n2/kim.pdf)

```{r, echo=FALSE, message = FALSE}

## OKCupid Data Explore

## Winston Saunders



library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)

```

The raw data is loaded as a library

```{r, echo = TRUE, comment=""}
## load data
library(okcupiddata)
```

and it consist of these data fields (detailed descriptions of which can be found in the reference above). 

```{r, echo = TRUE, comment="", highlight = TRUE}
library(dplyr)
## variable names
profiles %>% names
```

The dataset is very rich with abundant oppty to explore. This quick tour first looks at a few individual female - male behavior trends (in the first section below), and then focuses on the correlation of drinking habits to some of these trends in the second section. 


# OkCupid "Modal Hybrid User" (MHU)?  

We can do an interesting thought-experiment by asking "what is the hybrid of the most frequent value (i.e. mode) of each user-variable?" For short hand call this composite the "Modal Hybrid User" or MHU.

It's easily computed using a helper function which, when passed a data frame and a column names, returns the row value corresponding the most frequencly occurring (mode) of that set.

```{r echo = TRUE}

    max_freq <- function(col_name, df = profiles) {
        ## grabs the value of the max freq occurence in dataframe columns
        ## inputs: name: the name of a column and df: a dataframe
        ## output: the max frequency occurence in the selected column
        ##         more than one value may be returned, if none if found, NA is returned
        
        ## select column
        if (col_name %in% names(df)) {
            ## select the column. Note the use of "matches"
            sel_col <- df %>% select(matches(col_name))
        } else {
            sel_col <- NULL
        }
        
        ## compute frequency table
        col_table <- table(sel_col)
        
        ## choose maximum frequency
        if (length(col_table) >= 1) {
            names(col_table[col_table == max(col_table)]) %>% return
        } else {
            NA %>% return
        }
        
    }

```


```{r, echo = FALSE}

    ## make MFP data frame
    MFP <- data_frame("variable" = colnames(profiles), "MFP" = rep(NA, length(names(profiles))))

    profiles_m <- profiles %>% filter(sex == "m")
    ## loop thru all variable names in the profile

    ## loop thru all variable names in the profile
    for (ii in 1:(names(profiles) %>% length)) {
        
        ## get the max feq value
        m_f <- max_freq(MFP$variable[ii], profiles_m)
        ## assign it, with some modest exception handling.
        if (m_f %>% length > 1) {m_f <- paste0 (m_f[1] %>% as.character, " + others")}
        MFP[ii, 2] <- m_f
        
    }

MFP_m <- MFP

```



```{r results = 'asis', echo=FALSE}
library(xtable)
#print( xtable(MFP[-22,]), type="html", size="small", comment=FALSE, include.rownames=FALSE, html.table.attributes='border="3" align="center" ')

```

The MTH of the entire data set is a male. For greater interest, I computed `MTH_male` and `MTH_female` by filtering the profiles for each sex. To make it more interesting, when a category returned "other" those were also filtered.


```{r echo = FALSE}
MFP <- data_frame("variable" = colnames(profiles), "MFP" = rep(NA, length(names(profiles))))

    profiles_f <- profiles %>% filter(sex == "f")
    profiles_f <- profiles_f %>% filter(job != "other")
    profiles_f <- profiles_f %>% filter(religion != "other")
    ## loop thru all variable names in the profile
    for (ii in 1:(names(profiles) %>% length)) {
        
        ## get the max feq value
        m_f <- max_freq(MFP$variable[ii], profiles_f)
        ## assign it, with some modest exception handling.
        if (m_f %>% length > 1) {m_f <- paste0 (m_f[1] %>% as.character, " + others")}
        MFP[ii, 2] <- m_f
        
MFP_f <- MFP
        
    }
```

```{r, echo = FALSE}

MFP <- left_join(MFP_m, MFP_f, by="variable")
colnames(MFP) <- c("Factor", "MHU_male", "MHU_female")

```

```{r results = 'asis', echo=FALSE}

print( xtable(MFP[-22,]), type="html", size="small", comment=FALSE, include.rownames=FALSE, html.table.attributes='border="3" align="center" ')

```
 
The above outcomes translate into a coherent story about the male and female MPHs.

**The male MHU on OkCupid** is:  
a *white, straight, single, male,* who is *26* years old. He *graduated from college/university* and works in the *computer / hardware / software* industry. is body-type is *athletic* and is *5\' 10\"* tall. He eats *mostly anything*, drinks *socially*, but *never* takes drugs. He lives in *San Francisco*, *doesn't have kids* and *likes dogs and cats*. His astrological sign is *virgo but it doesn't matter* and when asked about religion responds *agnosticism and laughing about it*. He speaks only *english*. 

**The female MHU on OkCupid** is:  
a *white, straight, single, female,* who is *27* years old. She *graduated from college/university* and is a *student*. Her body type is *average* and is *5\' 4\"* tall. She eats *mostly anything*, drinks *socially*, but *never* takes drugs. She lives in *San Francisco*, *doesn't have kids* and *likes dogs and cats*. Her astrologic sign is *gemini and itâ€™s fun to think about*, and when asked about religion responds *agnosticism*. She speaks only *english*. 

This highlights some interesting similarities and differences between male and female MHU's:  
* men and women express similar social drinking and eating habits.  
* they are childless, single, but like pets.  
* they are predominantly not religious.   
* most men advertise themselves as athletic (as opposed to women, who are average).  
* women enjoy thinking about their astrological signs more than men do.  

# Male-Female Trends

The first thing to look at are  base behaviors and demographics of OkCupid users. Since we'll be splitting everything into male and female subsets, lets first get a handle on the differences in the population based on age and sex.

##How many more men than women use OkCupid?

This is a key question for any dating site. For instance in the [coverage of the Ashley Madison hack](http://www.businessinsider.com/ashley-madison-almost-no-women-2015-8) it was widely reported many more men than women used the site. How many more men than women use OkCupid?

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=9, tidy=TRUE}
## clean data
    ## eliminate NAs and restrict age
    cleaned <- filter(profiles, !is.na(age), !is.na(sex), age > 18, age < 80) %>% 
            as_data_frame %>%
            select(sex, age)
    ## make sex-data descriptive
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
```



```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5, tidy=FALSE}

## plot sex histogram
sex_hist <- ggplot(cleaned, aes(x= sex, fill = sex)) + 
    geom_bar(position = "dodge", stat = "count")  +
    ggtitle("okcupid: sex distribution") +
    scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
    ylab("count") + 
    xlab("age")

## plot age graph
cleaned2 <- group_by(cleaned[, c("sex", "age")], sex, age) %>% summarize(n_age = n())

age_graph <- ggplot(cleaned2, aes(x= age, y = n_age, color = sex)) + 
    geom_line(size = 1.5)  +
    ggtitle("number by age") +
    scale_color_manual(values = c("#DD9834", "#3498DD")) + 
    ylab("number") + 
    xlab("age") +
    theme(legend.position="none")

library(gridExtra)
grid.arrange(sex_hist, age_graph, ncol=2)

```

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

    ## compute age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))

    

    ## compute the overall number of men and women
    n_males <- analyzed %>% filter(sex == "male")  
    n_males <- n_males$n_sex %>% sum()
    
    n_females <- analyzed %>% filter(sex == "female") 
    n_females <- n_females$n_sex %>% sum()

```



The number of men, `r n_males`, is about `r round(n_males/n_females, 2)` times greater than the number of females, `r n_females`. Its hard to find comparitive references elsewhere for this information. For instance [this analysis by OkCupid](https://blog.okcupid.com/index.php/the-case-for-an-older-woman/) preselect fixed number of men and women. 

A couple of notable features of the chart on the right are that the distributions peaks in the late 20's with a long tail. 

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=9, tidy=TRUE}
    ## compute age quantiles. 
    age_data <- cleaned %>% select(age)
    age_quantiles <- age_data$age %>% quantile(c(.25, 0.75, 0.95))
    
    male_summary <- cleaned %>% filter(sex == "male") %>% select(age)
    male_deciles <- male_summary$age %>% quantile(c(.1, .5, .9, .95))
        
    female_summary <- cleaned %>% filter(sex == "female") %>% select(age)
    female_deciles <- female_summary$age %>% quantile(c(.1, .5, .9, 0.95))
```

50% of the population lies between the ages of `r age_quantiles[1]` and `r age_quantiles[2]` years old. The long tail implies 95% of the population is `r age_quantiles[3]` or younger (for men and women the 95th quantile is `r male_deciles[4]` years and `r female_deciles[4]` years, respectively). 

## How do male and female ages stack up?

The above chart on the right is useful, but it's hard to draw direct comparisons between male and female users ages. Another way to look is to compute an age group factor and use `dplyr::group_by` to compute the necessary subtotals. A stacked bar chart is a visually appealing and useful way to compare the results.

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5, tidy=TRUE}
## Compute differences between male and female populations by age.

    ## compute age_group factor using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 *  age %/% 4)
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    sex_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_sex = n())
    ## count the total number of males and females
    age_count <- group_by(analyzed[,c("age_group")], age_group) %>% summarize(n_age = n())
    
    ## join the data
    analyzed <- left_join(sex_count, age_count, by = "age_group") %>% mutate(freq = n_sex/n_age, freq = ifelse(is.na(freq), 0, freq), delta_percent = 200*(freq - 0.5))
```

This bar chart clearly shows the differences in age populations. To get around the default `ggplot` colors use `RColorBrewer::colorRampBrewer`. 

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5, tidy=TRUE}

    library(RColorBrewer)

    ## generate colors for plot
    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    ## plot
    p <- ggplot(analyzed, aes(x = sex, y = n_sex, fill = age_group, group=sex)) +
        geom_bar(stat="identity") +
        ggtitle("OkCupid: population by age and sex") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("number") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    print(p)

```

Let's look deeper at the populations. 

## Female-male bias by age 

In this comparison, we express the difference as a relative, rather than absolute, number by computing a __bias__ 
$$bias = \frac{f - m}{f + m}$$  
where $f$ is the number of females and $m$ is the number of males in a given age group. This formulation has the representational advantage that at $+100\%$ the population is all female and at $-100\%$ the population is all male.  
  
The female to male ratio is easily calculated from __bias__ using
$$\frac{f}{m} = \frac{1 + bias}{1 - bias}$$. 
So, for instance for $bias = -0.25$ a ratio of $f/m = 0.6$ or a 5:3 ratio of men to women.

```{r, echo = FALSE, fig.align='center', fig.height=3, warning = FALSE}
    
    
    analyzed2 <- analyzed %>% filter(sex == "male") %>% as.data.frame
    
    
    n.color <- length(unique(analyzed2$age_group))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))

    p <- ggplot(analyzed2, aes(x = age_group, y = 100* ((n_age - 2*n_sex)/n_age), fill = age_group)) +
        geom_bar(stat="identity", alpha = 1.0) +
        ylab("female-male bias (%)") +
        scale_fill_manual(values = getPalette(n.color)) +
        xlab("age") +
        ggtitle("normalized (female-male) bias by age") +
        theme(legend.position="none") 
    
print(p)
     
```

Th graph tells an intersting story. Relative to women, male interest in online dating peaks in their late 20's, plateaus through their 30's, then declines steadily beyond the upper 40's. There is an apparent resurgence in at age 70, though the number of users in this age range `

## Age distribution differences  

We know the difference between men and women is not uniform with age. We can explore this a bit more by separating the male and females populations and normalizing them to the relevant number of each sex.  
  
The code to do this counting is shown below.

```{r echo=TRUE, fig.align='center', fig.height=3,fig.width=7.5, tidy=TRUE}

    library(dplyr)

    ## put data into age groups using mutate
    analyzed <- cleaned %>% mutate(age_group = 2 + 4 * floor(age/4))
    analyzed$age_group <- analyzed$age_group %>% as.factor
    
    ## group_by data and summarize by sex and age
    age_count <- group_by(analyzed[,c("age_group", "sex")], age_group, sex) %>% summarize(n_age = n())
    ## count the total number of males and females
    sex_count <- group_by(analyzed[,c("sex")], sex) %>% summarize(n_sex = n())
    ## join the data
    analyzed <- left_join(age_count, sex_count, by = "sex") %>% mutate(freq = n_age/n_sex, freq = ifelse(is.na(freq), 0, freq))
```


```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
    
    ## Generate Distribution and Cummulative Plots

    ## distribution plot is straight forward
    p_dist <- ggplot(analyzed, aes(x = age_group, y = 100*freq, fill = sex, group = sex)) +
        geom_bar(stat = "identity", position = "dodge") +
        #geom_bar(aes(fill = sex), position = "dodge") +
        ggtitle("age distribution of sexes") +
        scale_fill_manual(values = c("#DD9834", "#3498DD")) + 
        ylab("percent of total per sex") + 
        xlab("age_group")
    
    
    ## Cummulative requires some manipuations
    ## first make a "wide" data set
    male <- analyzed %>% filter(sex == "male") %>% select(age_group, sex, freq)
    female <- analyzed %>% filter(sex == "female") %>% select(age_group, sex, freq)

    analyzed_wide <- inner_join(male, female, by = "age_group") %>% mutate(pop_diff = freq.x - freq.y)

    ## compute cummulative sums

    analyzed_wide2 <- analyzed_wide %>% as.data.frame %>% mutate(male_cummul = cumsum(freq.x), female_cummul = cumsum(freq.y))

    ## plot the data
    p_cummul <- ggplot(analyzed_wide2, aes(x = age_group, y = 100*male_cummul, group = sex.x)) +
        geom_line(size = 1.5, color = "#3498DD") +
        geom_line(aes(y = 100*female_cummul, group = sex.y), size = 1.5, color = "#DD9834") +
        ylab("cummulative percent") +
        xlab("age") +
        ggtitle("cummulative distributions by age") 
    


```


Both populations have a [gamma distribution-like shape](https://en.wikipedia.org/wiki/Gamma_distribution) with a mean near 28. The width of both distributions is about 12 years, though the women's distribution is slightly wider.  
  

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}
grid.arrange(p_dist, p_cummul, ncol=2)
```

Between the ages of 34 and 50 the relative frequency of both men and women are the same. For women, those above age 50 women represent a higher proportion of the female population than men do for the male population.
  
A nice way to look at the data is to create the stacked bar chart below. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5}

## Plot data

    library(ggplot2)

    ## build color palettes
    n.color <- length(unique(analyzed$age_group))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    ## create plot
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = age_group)) +
        geom_bar(stat="identity") +
        ggtitle("OkCupid: age distribution of male and female users") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
    
    
```

While the distribution differences between the male and populations are fairly subtle (~ a few percentage points), they have a profound impact on the age bias of the populations as seen above. 

# Male and Female Incomes Differences

Income data are reported as categorical variables as listed here:

```{r, comment = "", tidy=TRUE}
profiles$income %>% unique %>% sort
```

The differences in men's and women's are shown clearly with a stacked bar chart.

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(income), !is.na(religion), !is.na(sex)) %>% as_data_frame()
    #cleaned <- filter(cleaned, income != 1000000) %>% as_data_frame
    

    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    cleaned$income<- cleaned$income %>% as.factor()
    
    ## group the data 
    
    
    income_count <- group_by(cleaned[,c("income", "sex")], income, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(income_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$income))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = income)) +
        geom_bar(stat="identity") +
        ggtitle("reported income") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

Womens' incomes are lower than men's. A larger percentage of women, for example, report an income of $20,000 than do men. Men also have higher representation incomes above $100,000.  

The [median household income](https://en.wikipedia.org/wiki/San_Francisco) in 2011 for San Francisco was $72,947. The median of OkCupid user data $`r cleaned$income %>% as.character %>% as.integer %>% median` is below this, possibly related to the relatively young ages of most users. 

```{r}

p <- ggplot(cleaned, aes(x = age, y = income)) + geom_point()

```


The medians of both men's and women's incomes are the same. But looking at the means  

```{r, results = 'asis'}
## programming long chains of %>% are relatively straight forward, and can be read
## more easily if formatted...


cleaned_x_print <- cleaned %>% group_by(sex) %>%
    
    summarize(avg_income = (100 * ((income %>%
                  as.character %>%
                  as.integer %>%
                  mean) %/% 100) %>% 
                      as.integer)) %>% 

    xtable 
    
cleaned_x_print  %>%
    print(type = "html", comment = FALSE, include.rownames = FALSE)

```    

  
Shows women have about

# Religious affilation of OkCupid Users

The religion data contains statements of what I will call 'affiliation' and 'devoutness.'  For example, here is a sample of the data.

```{r, comment = ""}
set.seed(8675309)
sample(unique(profiles$religion), 4)
```

There is an affiliation with a base religion and then a statement of how serious (devout) one is about it. 

For a macro view of demographics, let's first strip off the devoutness descriptors to focus on affilation (so, for instance, whether someone typed _"catholicism and somewhat serious about it"_, or _"catholicism and very serious about it"_, they are affiliated as _"catholicism"_) 
  
The data are cleaned by filtering NA's and then grouped and counted as above. In this case I choose to eliminate the affilation "other" since it is not specific enough to facilitate comparison.  

```{r echo=4:6, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE, tidy=TRUE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned <- cleaned %>% mutate(religious_affil = gsub(' [A-z ]*', '', religion))
    cleaned <- cleaned %>% filter(religious_affil != "other")
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(religion_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
```

Using the familiar bar chart some trends are obvious.

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## make color palette
    n.color <- length(unique(analyzed$religious_affil))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    
    ## plot numbers of men and women by religion
    p <- ggplot(analyzed, aes(religious_affil, weight = group_count)) +
        geom_bar(aes(fill = religious_affil), alpha = 0.9) +
        ggtitle("OkCupid: Religious Affiliation of Users") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("number") + 
        xlab("religious affiliation")+
        theme(legend.position="none")
    
    #print(p)
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = religious_affil)) +
        geom_bar(stat="identity") +
        ggtitle("religious affiliation") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

The proportion of male users reporting an affiliation "atheism" and "agnosticism" is over 50%, with women beling slightly lower. Buddhism is about the same for both sexes, and of the major religions women outnumber men in all but Islam. 

# Drinking Habits of OkCupid Users

Drinking data has just six categories so this analysis didn't require any processing beyond normal cleaning of NA's.

```{r, comment = ""}
profiles$drinks %>% unique 
```

After cleaning the `NA`'s from the data, we can use the now familiar bar chart to show there is little difference between men and women in drinking habits. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    ## group the data 
    
    
    drinks_count <- group_by(cleaned[,c("drinks", "sex")], drinks, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(drinks_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = drinks)) +
        geom_bar(stat="identity") +
        ggtitle("drinking habits") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

Clearly the large majority of OkCupid users are social drinkers, with men having a slightly greater tendency to drink "often" than women.  
  
However, recall that over 50% of OkCupid users are in a very narrow age range. Below we'll explore how this trend changes when other factors are taken into account. 

## Drinking habits with age

The machinery above is easily adapted to exploring the relationship of drinking and age. Just to illustrate it I add the code below.  


```{r echo=TRUE, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE, tidy=TRUE}
    
    ## Clean Data
    ## eliminate NA's
    cleaned <- filter(profiles, !is.na(drinks), !is.na(age), !is.na(sex)) %>% as_data_frame
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    ## make data descriptive
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female",.)
    
 
    ## bucket ages into groups of 5 years
    cleaned <- mutate(cleaned, age_range = 2.5 + 5 * age %/% 5 )
    ## count the subsets of age, sex, and drinking habits
    drinks_and_sex <- group_by(cleaned, age_range, sex, drinks) %>% summarize(n=n())
    ## normalize with age and sed
    sex <- group_by(cleaned, age_range, sex) %>% summarize(NN=n())
    ## join the data
    analyzed <- left_join(drinks_and_sex, sex)
    ## compute percentage
    analyzed <- mutate(analyzed, percent = 100*n/NN)
    ## ensure no under-age drinking is reported
    analyzed <- filter(analyzed, age_range >= 20)
    
    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    ## plot
    p <- ggplot(analyzed, aes(age_range, weight = percent)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("oKCupid: change of drinking habits with age") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("age")
    
    
    
```

In this case clear trends emerge which were masked in the basic analysis above. 

```{r echo=FALSE, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}
  print(p)

```



There is a pronounced tendency toward lighter drinking in older age. 

These findings are consistent with, for instance, results [results published by _Annie Britton, Yoav Ben-Shlomo, Michaela Benzeval, Diana Kuh and Steven Bell_](http://bmcmedicine.biomedcentral.com/articles/10.1186/s12916-015-0273-z), who report also that drinking tends to decrease with increasing age. 

```{r echo = FALSE}
male_often_over_60 <- analyzed %>% filter(age_range >= 52.5, sex == "male", drinks == "often") %>% ungroup() %>% summarize(sum(n))

female_often_over_60 <-  analyzed %>% filter(age_range >= 52.5, sex == "female", drinks == "often") %>% ungroup() %>% summarize(sum(n))

mf_ratio <- male_often_over_60/female_often_over_60

```

  
One apparent diveregence between men and women in the "drinks often" above age 55. In this category the number of male drinkers is `r male_often_over_60` and female drinkers `r female_often_over_60`. These numbers together imply that the ratio 

$$ r = \frac{"drinks\ often"\ males\ over\ 50}{"drinks\ often"\ females\ over\ 50} = `r mf_ratio %>% round(2)` $$

but with an uncertainty from random error (so-called "counting statistics") of 

$$ \sigma = \sqrt{\frac{1}{"drinks\ often"\ males\ over\ 50} + \frac{1}{"drinks\ often"\ females\ over\ 50} } = `r 100*sqrt(1/male_often_over_60 + 1/female_often_over_60) %>% round(2)` \% $$


Thus, while men appear about twice as likely as women to drink heavily above age 50, the result is not extremely high confidence. 

We get a better look at some of the more subtle trends in the data using a semi-log plot. Again, the age data has been bucketing into groups of five years.  
    
```{r echo=FALSE, fig.align='center', fig.height=4,fig.width=6.5, message = FALSE}   
## clean data into broad category
    cleaned <- filter(profiles, !is.na(drinks), !is.na(age), !is.na(sex)) %>% as_data_frame
    
    ## set factor order
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female",.)
    
    #ggplot(cleaned, aes(x = drinks, y = age)) + 
        #geom_violin(alpha = 0.3, size = 1, fill = "#FF9933", color = "darkred") + 
        #ggtitle("okcupid: drinks versus age") + facet_grid(sex~.)
    
    cleaned <- mutate(cleaned, age_range = 2.5 + 5 * age %/% 5 )
    
    drinks_and_sex <- group_by(cleaned, age_range, sex, drinks) %>% summarize(n=n())
    
    sex <- group_by(cleaned, age_range, sex) %>% summarize(NN=n())
    
    analyzed <- left_join(drinks_and_sex, sex)
    
    analyzed <- mutate(analyzed, percent = 100*n/NN)
    analyzed <- filter(analyzed, age_range >= 20)


    p3 <- ggplot(analyzed, aes(x = age_range, y = percent, color = drinks)) + geom_line(size = 1.2) +
        scale_color_manual(values = getPalette(n.color)) + 
        facet_grid(sex~.) +
        ggtitle("okcupid: drinking versus age") + 
        scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p3)
    
```  


##Drinking Habits and Income



```{r echo = FALSE, fig.align = 'center', fig.height = 4 , fig.width = 7.5 , message = FALSE}
 
    
    ## clean religion data into broad category
    cleaned <- filter(profiles, !is.na(income), !is.na(drinks), !is.na(sex)) %>% as_data_frame
    
    cleaned$income <- cleaned$income %>% as.factor()
    
    
    cleaned$drinks <- factor(cleaned$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    ## group the data 
    income_and_drinks <- group_by(cleaned[,c("drinks", "sex", "income")], drinks, sex, income) %>% summarize(n = n())
    
    income <- group_by(cleaned[,c("drinks", "income", "sex")], income) %>% summarize(NN = n())
    
  
    analyzed <- left_join(income_and_drinks, income) %>% mutate(freq = n/NN, freq = ifelse(is.na(freq), 0, freq))
    
    

    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                            "rarely",
                                                            "socially",
                                                            "often",
                                                            "very often",
                                                            "desperately"))
    
    n.color <- length(unique(analyzed$income))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    p <- ggplot(analyzed, aes(income, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), position = "stack", alpha = 1) +
        ggtitle("drinking and income") + 
        facet_grid(sex~.) +
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("income") +
        coord_flip()
        
        #scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p)
    
```    

The most obvious in the graph above is that social drinking, the largest component of the spectrum, shows an obvious trend, with social drinking peaking in the middle of the income range and decreasing on the edges. 

```{r echo = FALSE, fig.align = 'center', fig.height = 3 , fig.width = 7.5 , message = FALSE}

    p3 <- ggplot(analyzed, aes(x = income, y = 100*freq, color = drinks, group = drinks)) + geom_line(size = 1.2) +
        scale_color_manual(values = getPalette(n.color)) + 
        facet_grid(sex~.) +
        ggtitle("drinking and income") + 
        ylab("percent") +
        scale_y_log10(breaks = c(0.2, 0.5, 1, 2, 5, 10, 20, 50, 100))
    
    print(p3)

```


## Drinking and Religion
The data `religion` contains statements of both 'affiliation' and (what I call) 'devoutness'. For example

```{r, comment = ""}
head(unique(profiles$religion), 5)
```


For a first analysis, let's just strip off the devoutness descriptors to focus on affilation (so, for instance, whether someone typed _"catholicism and somewhat serious about it"_, or _"catholicism and very serious about it"_, they would be have an affiliation of catholicism).   
  
Drinking habits are characterized by self-described ratings of _"not at all"_, ... _"socially"_, ..._"desperately"_.  
  
The data are cleaned by filtering NA's and then grouped and counted.

```{r echo=1:5, fig.align='center', fig.height=5,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(drinks), !is.na(religion), !is.na(sex)) %>% as_data_frame
    
    ## get affiliation (strip devoutness modifiers) using gsub and simple regex
    cleaned$religious_affil <- gsub(' [A-z ]*', '', cleaned$religion) %>% as.factor()
    
    ## convert cleaned$drinks to factor
    cleaned$drinks <- cleaned$drinks %>% as.factor()
    
    ## group the data 
    drinks_and_religion <- group_by(cleaned[,c("drinks", "religious_affil", "sex")], drinks, religious_affil, sex) %>% summarize(n = n())
    
    
    religion_count <- group_by(cleaned[,c("religious_affil", "sex")], religious_affil, sex) %>% summarize(group_count = n())
    

    
    analyzed <- left_join(drinks_and_religion, religion_count) %>% mutate(freq = n/group_count, freq = ifelse(is.na(freq), 0, freq))

 
    ## Clean up for display
    
    ## reorder factor
    analyzed$drinks <- factor(analyzed$drinks, levels = c("not at all", 
                                                           "rarely",
                                                           "socially",
                                                           "often",
                                                           "very often",
                                                           "desperately"))
    
    
    
    ## express sex in actual words
    
    analyzed$sex<- analyzed$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)

    ## make color palette
    
    n.color <- length(unique(analyzed$drinks))
    getPalette = colorRampPalette(brewer.pal(9, "Paired"))
    
    
    ## plot
    p <- ggplot(analyzed, aes(religious_affil, weight = 100*freq)) +
        geom_bar(aes(fill = drinks), alpha = 0.9) +
        ggtitle("okcupid: drinking and religion") + facet_grid(sex~.) +
        coord_flip() + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("religious affiliation")
    
    print(p)
```

Some obvious patterns reveal themselves. 
* Social drinking is by far the largest category.
* Athesists and agnostics are the heaviest drinkers 
* Islamic males also have a higher frequency of heavy drinking.
* Jewish people have the lowest rate of abstinence.


  

#Ethnicity of OkCupid users

Ethnicity is reported as below is to complex for analysis.

```{r, comment = "", echo = FALSE}
set.seed(8765309)
profiles$ethnicity %>% unique() %>% sample(3)
```

Indeed, since there are `r length(profiles$ethnicity %>% unique())` unqiue categories, some reduction is needed.  
  
To meet speed and simplicity goals, I stripped off everything except the first descriptor. This is a gross oversimplication of ethicity in an ever-more-diverse world, but it's a reasonable first approach. It results in tangible categories which can be compared to existing data. 

```{r echo=FALSE, fig.align='center', fig.height=3,fig.width=7.5, message = FALSE}
    ## clean data 
    cleaned <- filter(profiles, !is.na(income), !is.na(ethnicity), !is.na(sex)) %>% as_data_frame
    
    ## concatenate some word types
    cleaned$ethnicity <- gsub('middle eastern', 'middle_eastern', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('pacific islander', 'pacific_islander', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('native american', 'native_american', cleaned$ethnicity) 
    cleaned$ethnicity <- gsub('hispanic \\/ latin', 'hispanic_latin', cleaned$ethnicity) 

    ## strip everything after the first comma
    cleaned$ethnicity <- gsub(',( [a-z_]*)', '', cleaned$ethnicity) %>% as.factor()
    
    ## change sex to descriptive names
    cleaned$sex<- cleaned$sex %>% gsub("m", "male", .) %>% gsub("f", "female", .)
    
    cleaned$ethnicity <- cleaned$ethnicity %>% as.factor()
    
    
    ## group the data 
    
    
    ethnicity_count <- group_by(cleaned[,c("ethnicity", "sex")], ethnicity, sex) %>% summarize(group_count = n())
    
    sex_count <- group_by(cleaned[,c("sex")], sex) %>% summarize(sex_count = n())
    
    analyzed <- left_join(ethnicity_count, sex_count, by = "sex") %>% mutate(freq = group_count/sex_count, freq = ifelse(is.na(freq), 0, freq))
    
  
    ## make color palette
    n.color <- length(unique(analyzed$ethnicity))
    getPalette = colorRampPalette(brewer.pal(6, "Dark2"))
    
    
    ## plot the relative percentage of men and women per religion
    p <- ggplot(analyzed, aes(x = sex, y = 100*freq, fill = ethnicity)) +
        geom_bar(stat="identity") +
        ggtitle("ethnicity of OkCupid users") + 
        scale_fill_manual(values = getPalette(n.color)) + 
        ylab("percent") + 
        xlab("") +
        coord_flip()+
        theme(legend.position="bottom") +
        guides(fill=guide_legend(nrow=2))
        
    
    print(p)
```

A majority of OkCupid users are found to be white, with small differences between the male and female populations of other ethnicities. The numbers above do not reflect [the demographics of San Francisco's population as a whole](https://en.wikipedia.org/wiki/San_Francisco), which is 48.5% White, 33% asian, 15% Hispanic, and 6% Black. 


## Some Conclusions  



